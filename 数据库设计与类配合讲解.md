# æ•°æ®åº“è®¾è®¡ä¸ç±»é…åˆå…³ç³»è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£é¡¹ç›®çš„æ•°æ®åº“è®¾è®¡å’Œå„ä¸ªç±»ä¹‹é—´çš„é…åˆå…³ç³»ã€‚

## ğŸ“š ç›®å½•

- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [ç±»ä¹‹é—´çš„å…³ç³»](#ç±»ä¹‹é—´çš„å…³ç³»)
- [æ•°æ®æµè½¬è¿‡ç¨‹](#æ•°æ®æµè½¬è¿‡ç¨‹)
- [è®¾è®¡æ¨¡å¼åº”ç”¨](#è®¾è®¡æ¨¡å¼åº”ç”¨)
- [å…³é”®ä»£ç åˆ†æ](#å…³é”®ä»£ç åˆ†æ)

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ä¸€ã€å®¢æˆ·ç«¯æ•°æ®åº“è®¾è®¡

å®¢æˆ·ç«¯ä½¿ç”¨ **ä¸¤ä¸ªç‹¬ç«‹çš„ SQLite æ•°æ®åº“**ï¼Œåˆ†åˆ«å­˜å‚¨ç”¨æˆ·ä¿¡æ¯å’Œæ¶ˆæ¯è®°å½•ã€‚

#### 1.1 ç”¨æˆ·æ•°æ®åº“ (user.db)

**æ•°æ®åº“è¿æ¥å**ï¼š`connectionUser`

**è¡¨ç»“æ„**ï¼š

##### FRIEND è¡¨ï¼ˆå¥½å‹è¡¨ï¼‰
```sql
CREATE TABLE FRIEND (
    id INT,           -- å¥½å‹çš„ç”¨æˆ·ID
    userId INT,       -- å½“å‰ç”¨æˆ·çš„ID
    name varchar(50) -- å¥½å‹åç§°
)
```

**è®¾è®¡è¯´æ˜**ï¼š
- `id`ï¼šå¥½å‹çš„ç”¨æˆ·IDï¼ˆæœåŠ¡å™¨åˆ†é…çš„å”¯ä¸€æ ‡è¯†ï¼‰
- `userId`ï¼šå½“å‰ç™»å½•ç”¨æˆ·çš„ID
- `name`ï¼šå¥½å‹çš„ç”¨æˆ·å
- **å…³ç³»**ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå¥½å‹ï¼Œé€šè¿‡ `userId` åŒºåˆ†ä¸åŒç”¨æˆ·çš„å¥½å‹åˆ—è¡¨

**ç¤ºä¾‹æ•°æ®**ï¼š
```
id  | userId | name
----|--------|-------
1002| 1001   | å¼ ä¸‰
1003| 1001   | æå››
1002| 1003   | å¼ ä¸‰  (ç”¨æˆ·1003çš„å¥½å‹åˆ—è¡¨)
```

##### MYGROUP è¡¨ï¼ˆç¾¤ç»„è¡¨ï¼‰
```sql
CREATE TABLE MYGROUP (
    id INT,           -- ç¾¤ç»„ID
    userId INT,       -- å½“å‰ç”¨æˆ·çš„ID
    name varchar(50) -- ç¾¤ç»„åç§°
)
```

**è®¾è®¡è¯´æ˜**ï¼š
- `id`ï¼šç¾¤ç»„IDï¼ˆæœåŠ¡å™¨åˆ†é…ï¼‰
- `userId`ï¼šå½“å‰ç”¨æˆ·ID
- `name`ï¼šç¾¤ç»„åç§°
- **å…³ç³»**ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥åŠ å…¥å¤šä¸ªç¾¤ç»„

##### USERINFO è¡¨ï¼ˆç”¨æˆ·ä¿¡æ¯è¡¨ï¼‰
```sql
CREATE TABLE USERINFO (
    id INT,              -- ç”¨æˆ·ID
    name varchar(50),    -- ç”¨æˆ·å
    passwd varchar(50)   -- å¯†ç ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
)
```

**è®¾è®¡è¯´æ˜**ï¼š
- å­˜å‚¨å½“å‰ç™»å½•ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯
- ç”¨äºå¿«é€Ÿè®¿é—®ï¼Œé¿å…æ¯æ¬¡éƒ½ä»æœåŠ¡å™¨è·å–

#### 1.2 æ¶ˆæ¯æ•°æ®åº“ (msg.db)

**æ•°æ®åº“è¿æ¥å**ï¼š`connectionMsg`

##### MSGINFO è¡¨ï¼ˆæ¶ˆæ¯å†å²è®°å½•è¡¨ï¼‰
```sql
CREATE TABLE MSGINFO (
    id INT PRIMARY KEY,      -- æ¶ˆæ¯IDï¼ˆè‡ªå¢ï¼‰
    userId INT,               -- å¥½å‹/ç¾¤ç»„ID
    name varchar(20),         -- å‘é€è€…/æ¥æ”¶è€…åç§°
    head varchar(50),         -- å¤´åƒæ–‡ä»¶å
    datetime varchar(20),     -- æ¶ˆæ¯æ—¶é—´
    filesize varchar(30),     -- æ–‡ä»¶å¤§å°ï¼ˆå¦‚æœæ˜¯æ–‡ä»¶æ¶ˆæ¯ï¼‰
    content varchar(500),     -- æ¶ˆæ¯å†…å®¹
    type INT,                 -- æ¶ˆæ¯ç±»å‹ï¼ˆText/Audio/Picture/Filesï¼‰
    direction INT             -- æ–¹å‘ï¼ˆ0:æ¥æ”¶, 1:å‘é€ï¼‰
)
```

**è®¾è®¡è¯´æ˜**ï¼š
- `id`ï¼šæ¶ˆæ¯å”¯ä¸€æ ‡è¯†ï¼Œè‡ªå¢ä¸»é”®
- `userId`ï¼šå¦‚æœæ˜¯ç§èŠï¼Œå­˜å‚¨å¥½å‹IDï¼›å¦‚æœæ˜¯ç¾¤èŠï¼Œå­˜å‚¨ç¾¤ç»„ID
- `type`ï¼šæ¶ˆæ¯ç±»å‹æšä¸¾å€¼
  - `0`ï¼šTextï¼ˆæ–‡æœ¬ï¼‰
  - `1`ï¼šAudioï¼ˆè¯­éŸ³ï¼‰
  - `2`ï¼šPictureï¼ˆå›¾ç‰‡ï¼‰
  - `3`ï¼šFilesï¼ˆæ–‡ä»¶ï¼‰
- `direction`ï¼šæ¶ˆæ¯æ–¹å‘
  - `0`ï¼šæ¥æ”¶çš„æ¶ˆæ¯
  - `1`ï¼šå‘é€çš„æ¶ˆæ¯

**æ•°æ®ç¤ºä¾‹**ï¼š
```
id | userId | name | datetime          | content    | type | direction
---|--------|------|-------------------|------------|------|----------
1  | 1002   | å¼ ä¸‰ | 2024/01/01 12:00  | ä½ å¥½       | 0    | 0
2  | 1002   | æˆ‘   | 2024/01/01 12:01  | ä½ å¥½ï¼     | 0    | 1
3  | 1003   | æå›› | 2024/01/01 12:05  | åœ¨å—ï¼Ÿ     | 0    | 0
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… åˆ†ç¦»ç”¨æˆ·æ•°æ®å’Œæ¶ˆæ¯æ•°æ®ï¼Œä¾¿äºç®¡ç†
- âœ… æ¶ˆæ¯è¡¨æ”¯æŒå¿«é€ŸæŸ¥è¯¢å†å²è®°å½•
- âœ… é€šè¿‡ `userId` å¯ä»¥å¿«é€ŸåŠ è½½æŸä¸ªå¥½å‹/ç¾¤ç»„çš„èŠå¤©è®°å½•

---

### äºŒã€æœåŠ¡å™¨ç«¯æ•°æ®åº“è®¾è®¡

æœåŠ¡å™¨ç«¯ä½¿ç”¨ **ä¸€ä¸ª SQLite æ•°æ®åº“**ï¼Œé›†ä¸­ç®¡ç†æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€‚

#### 2.1 ä¸»æ•°æ®åº“ (info.db)

**è¡¨ç»“æ„**ï¼š

##### USERINFO è¡¨ï¼ˆç”¨æˆ·ä¿¡æ¯è¡¨ï¼‰
```sql
CREATE TABLE USERINFO (
    id INT PRIMARY KEY,      -- ç”¨æˆ·IDï¼ˆä¸»é”®ï¼Œè‡ªå¢ï¼‰
    name varchar(20),        -- ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰
    passwd varchar(20),      -- å¯†ç ï¼ˆæ˜æ–‡ï¼Œå®é™…åº”åŠ å¯†ï¼‰
    head varchar(20),        -- å¤´åƒæ–‡ä»¶å
    status INT,              -- åœ¨çº¿çŠ¶æ€ï¼ˆ0:ç¦»çº¿, 1:åœ¨çº¿ï¼‰
    -- groupId INT,             -- æ‰€å±ç¾¤ç»„IDï¼ˆå·²å¼ƒç”¨ï¼‰
    lasttime DATETIME        -- æœ€åç™»å½•æ—¶é—´
)
```

**è®¾è®¡è¯´æ˜**ï¼š
- `id`ï¼šç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼Œä¸»é”®
- `name`ï¼šç”¨æˆ·åï¼Œåº”è¯¥è®¾ç½®å”¯ä¸€ç´¢å¼•ï¼ˆä»£ç ä¸­æœªå®ç°ï¼‰
- `status`ï¼šåœ¨çº¿çŠ¶æ€ï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢åœ¨çº¿ç”¨æˆ·
- `lasttime`ï¼šè®°å½•æœ€åç™»å½•æ—¶é—´ï¼Œç”¨äºç»Ÿè®¡

**æ•°æ®ç¤ºä¾‹**ï¼š
```
id  | name  | passwd | head   | status | lasttime
----|-------|--------|--------|--------|------------------
1001| admin | 123456 | 2.bmp  | 1      | 2024/01/01 12:00
1002| å¼ ä¸‰  | 123456 | 0.bmp  | 1      | 2024/01/01 12:05
1003| æå››  | 123456 | 1.bmp  | 0      | 2024/01/01 11:50
```

##### GROUPINFO è¡¨ï¼ˆç¾¤ç»„ä¿¡æ¯è¡¨ï¼‰
```sql
CREATE TABLE GROUPINFO (
    id INT PRIMARY KEY,      -- è®°å½•IDï¼ˆä¸»é”®ï¼‰
    groupId INT,              -- ç¾¤ç»„IDï¼ˆå®é™…ç¾¤ç»„æ ‡è¯†ï¼‰
    name varchar(20),         -- ç¾¤ç»„åç§°
    head varchar(20),         -- ç¾¤ç»„å¤´åƒ
    userId INT,              -- ç”¨æˆ·IDï¼ˆç¾¤ç»„æˆå‘˜ï¼‰
    identity INT             -- èº«ä»½ï¼ˆ1:åˆ›å»ºè€…, 3:æ™®é€šæˆå‘˜ï¼‰
)
```

**è®¾è®¡è¯´æ˜**ï¼š
- `id`ï¼šè®°å½•å”¯ä¸€æ ‡è¯†ï¼ˆè‡ªå¢ä¸»é”®ï¼‰
- `groupId`ï¼šç¾¤ç»„IDï¼ŒåŒä¸€ä¸ªç¾¤ç»„çš„æ‰€æœ‰æˆå‘˜å…±äº«ç›¸åŒçš„ `groupId`
- `userId`ï¼šç¾¤ç»„æˆå‘˜ID
- `identity`ï¼šæˆå‘˜èº«ä»½
  - `1`ï¼šç¾¤ä¸»/åˆ›å»ºè€…
  - `3`ï¼šæ™®é€šæˆå‘˜

**æ•°æ®ç¤ºä¾‹**ï¼š
```
id | groupId | name  | head  | userId | identity
---|---------|-------|-------|--------|---------
1  | 1      | æŠ€æœ¯éƒ¨ | 1.bmp | 1001   | 1
2  | 1      | æŠ€æœ¯éƒ¨ | 1.bmp | 1002   | 3
3  | 1      | æŠ€æœ¯éƒ¨ | 1.bmp | 1003   | 3
4  | 2      | äº§å“éƒ¨ | 1.bmp | 1001   | 1
```

**è®¾è®¡é—®é¢˜**ï¼š
- âš ï¸ ç¾¤ç»„è®¾è®¡ä¸å¤Ÿè§„èŒƒï¼Œåº”è¯¥åˆ†ä¸º `groups`ï¼ˆç¾¤ç»„åŸºæœ¬ä¿¡æ¯ï¼‰å’Œ `group_members`ï¼ˆç¾¤ç»„æˆå‘˜å…³ç³»ï¼‰ä¸¤ä¸ªè¡¨
- âš ï¸ å½“å‰è®¾è®¡å¯¼è‡´ç¾¤ç»„åç§°å’Œå¤´åƒé‡å¤å­˜å‚¨

##### USERHEAD è¡¨ï¼ˆç”¨æˆ·å¤´åƒè¡¨ï¼‰
```sql
CREATE TABLE USERHEAD (
    id INT PRIMARY KEY,      -- è®°å½•ID
    name varchar(20),         -- ç”¨æˆ·å
    data varchar(20)          -- å¤´åƒæ•°æ®ï¼ˆBase64ç¼–ç æˆ–æ–‡ä»¶è·¯å¾„ï¼‰
)
```

**è®¾è®¡è¯´æ˜**ï¼š
- ç”¨äºå­˜å‚¨ç”¨æˆ·å¤´åƒæ•°æ®
- å¯ä»¥å­˜å‚¨ Base64 ç¼–ç çš„å›¾ç‰‡æ•°æ®æˆ–æ–‡ä»¶è·¯å¾„

---

### ä¸‰ã€æ•°æ®åº“è®¾è®¡å¯¹æ¯”

| ç‰¹æ€§ | å®¢æˆ·ç«¯ | æœåŠ¡å™¨ç«¯ |
|------|--------|----------|
| **æ•°æ®åº“æ•°é‡** | 2ä¸ªï¼ˆuser.db, msg.dbï¼‰ | 1ä¸ªï¼ˆinfo.dbï¼‰ |
| **è®¾è®¡ç›®çš„** | æœ¬åœ°ç¼“å­˜ï¼Œå¿«é€Ÿè®¿é—® | é›†ä¸­ç®¡ç†ï¼Œæ•°æ®ä¸€è‡´æ€§ |
| **æ•°æ®åŒæ­¥** | ä»æœåŠ¡å™¨è·å–å¹¶ç¼“å­˜ | æ•°æ®æºï¼Œæƒå¨æ•°æ® |
| **ç”¨æˆ·ä¿¡æ¯** | åªå­˜å‚¨å½“å‰ç”¨æˆ·å’Œå¥½å‹ | å­˜å‚¨æ‰€æœ‰ç”¨æˆ· |
| **æ¶ˆæ¯å­˜å‚¨** | å­˜å‚¨å†å²èŠå¤©è®°å½• | ä¸å­˜å‚¨æ¶ˆæ¯ï¼ˆå¯æ‰©å±•ï¼‰ |
| **å¥½å‹å…³ç³»** | å­˜å‚¨å½“å‰ç”¨æˆ·çš„å¥½å‹åˆ—è¡¨ | ä¸ç›´æ¥å­˜å‚¨ï¼ˆé€šè¿‡æŸ¥è¯¢å®ç°ï¼‰ |

**è®¾è®¡ç†å¿µ**ï¼š
- **å®¢æˆ·ç«¯**ï¼šä»¥ç”¨æˆ·ä½“éªŒä¸ºä¸­å¿ƒï¼Œæœ¬åœ°ç¼“å­˜å‡å°‘ç½‘ç»œè¯·æ±‚
- **æœåŠ¡å™¨ç«¯**ï¼šä»¥æ•°æ®ä¸€è‡´æ€§ä¸ºä¸­å¿ƒï¼Œé›†ä¸­ç®¡ç†æ‰€æœ‰æ•°æ®

---

## ğŸ”— ç±»ä¹‹é—´çš„å…³ç³»

### ä¸€ã€å®¢æˆ·ç«¯ç±»å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      main.cpp                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   MyApp      â”‚  â”‚ DataBaseMagr â”‚  â”‚ LoginWidget   â”‚  â”‚
â”‚  â”‚ (é…ç½®ç®¡ç†)    â”‚  â”‚ (æ•°æ®åº“ç®¡ç†)  â”‚  â”‚ (ç™»å½•ç•Œé¢)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚          â”‚
â”‚                                               â”‚ åˆ›å»º      â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                    â”‚  ClientSocket    â”‚  â”‚
â”‚                                    â”‚  (ç½‘ç»œé€šä¿¡)       â”‚  â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚          â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                    â”‚   MainWindow     â”‚  â”‚
â”‚                                    â”‚   (ä¸»çª—å£)        â”‚  â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚          â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                      â”‚                        â”‚        â”‚ â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚            â”‚  ChatWindow    â”‚      â”‚  QQListView   â”‚ â”‚ â”‚
â”‚            â”‚  (èŠå¤©çª—å£)     â”‚      â”‚  (å¥½å‹åˆ—è¡¨)    â”‚ â”‚ â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                      â”‚                                â”‚ â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                        â”‚ â”‚
â”‚            â”‚ClientFileSocketâ”‚                        â”‚ â”‚
â”‚            â”‚  (æ–‡ä»¶ä¼ è¾“)     â”‚                        â”‚ â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äºŒã€æ ¸å¿ƒç±»èŒè´£

#### 2.1 MyAppï¼ˆé…ç½®ç®¡ç†ç±»ï¼‰

**ä½ç½®**ï¼š`comapi/myapp.*`

**èŒè´£**ï¼š
- ç®¡ç†åº”ç”¨ç¨‹åºè·¯å¾„
- è¯»å†™é…ç½®æ–‡ä»¶ï¼ˆINIæ ¼å¼ï¼‰
- æä¾›å…¨å±€é…ç½®å˜é‡

**å…³é”®æˆå‘˜å˜é‡**ï¼š
```cpp
static QString m_strAppPath;        // åº”ç”¨ç¨‹åºè·¯å¾„
static QString m_strDatabasePath;   // æ•°æ®åº“è·¯å¾„
static QString m_strHostAddr;       // æœåŠ¡å™¨åœ°å€
static int     m_nMsgPort;          // æ¶ˆæ¯ç«¯å£
static int     m_nFilePort;         // æ–‡ä»¶ç«¯å£
static QString m_strUserName;       // ç”¨æˆ·å
static QString m_strPassword;       // å¯†ç 
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–è·¯å¾„
- ç™»å½•æ—¶è¯»å–/ä¿å­˜æœåŠ¡å™¨é…ç½®
- å„ä¸ªæ¨¡å—è·å–é…ç½®ä¿¡æ¯

#### 2.2 DataBaseMagrï¼ˆæ•°æ®åº“ç®¡ç†ç±»ï¼‰

**ä½ç½®**ï¼š`databasemagr.*`

**è®¾è®¡æ¨¡å¼**ï¼š**å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰**

**èŒè´£**ï¼š
- ç®¡ç†æ•°æ®åº“è¿æ¥
- æä¾›æ•°æ®è®¿é—®æ¥å£
- å°è£… SQL æ“ä½œ

**å…³é”®æ–¹æ³•**ï¼š
```cpp
// å•ä¾‹è·å–
static DataBaseMagr *Instance();

// æ‰“å¼€æ•°æ®åº“
bool OpenUserDb(const QString &dataName);
bool OpenMessageDb(const QString &dataName);

// å¥½å‹æ“ä½œ
void AddFriend(const int &id, const int &userId, const QString &name);
QJsonArray GetMyFriend(const int &userId) const;
bool DeleteMyFriend(const int &id, const int &userId);

// æ¶ˆæ¯æ“ä½œ
void AddHistoryMsg(const int &userId, ItemInfo *itemInfo);
QVector<ItemInfo *> QueryHistory(const int &id, const int &count = 0);
```

**å•ä¾‹å®ç°**ï¼š
```cpp
DataBaseMagr *DataBaseMagr::self = NULL;

static DataBaseMagr *Instance()
{
    static QMutex mutex;
    if (NULL == self) {
        QMutexLocker locker(&mutex);  // çº¿ç¨‹å®‰å…¨
        if (!self) {
            self = new DataBaseMagr();
        }
    }
    return self;
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨å•ä¾‹**ï¼š
- âœ… å…¨å±€åªéœ€è¦ä¸€ä¸ªæ•°æ®åº“è¿æ¥
- âœ… é¿å…é‡å¤åˆ›å»ºè¿æ¥
- âœ… ç»Ÿä¸€ç®¡ç†æ•°æ®è®¿é—®

#### 2.3 ClientSocketï¼ˆç½‘ç»œé€šä¿¡ç±»ï¼‰

**ä½ç½®**ï¼š`clientsocket.*`

**èŒè´£**ï¼š
- ç®¡ç† TCP è¿æ¥
- å‘é€/æ¥æ”¶æ¶ˆæ¯
- JSON åºåˆ—åŒ–/ååºåˆ—åŒ–

**å…³é”®æ–¹æ³•**ï¼š
```cpp
// è¿æ¥ç®¡ç†
void ConnectToHost(const QString &host, const int &port);
void ColseConnected();

// æ¶ˆæ¯å‘é€
void SltSendMessage(const quint8 &type, const QJsonValue &dataVal);

// æ¶ˆæ¯æ¥æ”¶ï¼ˆæ§½å‡½æ•°ï¼‰
void SltReadyRead();
```

**ä¿¡å·**ï¼š
```cpp
signals:
    void signalMessage(const quint8 &type, const QJsonValue &dataVal);
    void signalStatus(const quint8 &state);
```

**ä¸å…¶ä»–ç±»çš„å…³ç³»**ï¼š
- **è¢« LoginWidget ä½¿ç”¨**ï¼šç™»å½•æ—¶è¿æ¥æœåŠ¡å™¨
- **è¢« MainWindow ä½¿ç”¨**ï¼šå‘é€/æ¥æ”¶æ¶ˆæ¯
- **å‘å°„ä¿¡å·ç»™ MainWindow**ï¼šé€šçŸ¥æ”¶åˆ°æ–°æ¶ˆæ¯

#### 2.4 MainWindowï¼ˆä¸»çª—å£ç±»ï¼‰

**ä½ç½®**ï¼š`mainwindow.*`

**èŒè´£**ï¼š
- ç®¡ç†å¥½å‹/ç¾¤ç»„åˆ—è¡¨
- ç®¡ç†èŠå¤©çª—å£
- æ¶ˆæ¯è·¯ç”±åˆ†å‘
- ç³»ç»Ÿæ‰˜ç›˜ç®¡ç†

**å…³é”®æˆå‘˜å˜é‡**ï¼š
```cpp
QList<ChatWindow *> m_chatFriendWindows;  // å¥½å‹èŠå¤©çª—å£åˆ—è¡¨
QList<ChatWindow *> m_chatGroupWindows;    // ç¾¤ç»„èŠå¤©çª—å£åˆ—è¡¨
ClientSocket *m_tcpSocket;                  // ç½‘ç»œé€šä¿¡å¯¹è±¡
```

**å…³é”®æ–¹æ³•**ï¼š
```cpp
// è®¾ç½® Socketï¼ˆç™»å½•æˆåŠŸåè°ƒç”¨ï¼‰
void SetSocket(ClientSocket *tcpSocket, const QString &name);

// æ¶ˆæ¯å¤„ç†
void SltTcpReply(const quint8 &type, const QJsonValue &dataVal);
void ParseFriendMessageReply(const QJsonValue &dataVal);
void ParseGroupMessageReply(const QJsonValue &dataVal);

// çª—å£ç®¡ç†
void SltFriendsClicked(QQCell *cell);  // æ‰“å¼€èŠå¤©çª—å£
void SltFriendChatWindowClose();       // å…³é—­èŠå¤©çª—å£
```

**ä¸å…¶ä»–ç±»çš„å…³ç³»**ï¼š
- **ä½¿ç”¨ ClientSocket**ï¼šå‘é€/æ¥æ”¶æ¶ˆæ¯
- **ä½¿ç”¨ DataBaseMagr**ï¼šæŸ¥è¯¢å¥½å‹åˆ—è¡¨ã€ä¿å­˜æ•°æ®
- **ç®¡ç† ChatWindow**ï¼šåˆ›å»ºã€æ˜¾ç¤ºã€å…³é—­èŠå¤©çª—å£
- **ä½¿ç”¨ QQListView**ï¼šæ˜¾ç¤ºå¥½å‹/ç¾¤ç»„åˆ—è¡¨

#### 2.5 ChatWindowï¼ˆèŠå¤©çª—å£ç±»ï¼‰

**ä½ç½®**ï¼š`uipage/chatwindow.*`

**èŒè´£**ï¼š
- æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯
- å‘é€æ¶ˆæ¯
- æ–‡ä»¶ä¼ è¾“
- åŠ è½½å†å²è®°å½•

**å…³é”®æˆå‘˜å˜é‡**ï¼š
```cpp
QQCell *m_cell;                    // å½“å‰èŠå¤©å¯¹è±¡ä¿¡æ¯
ClientFileSocket *m_tcpFileSocket; // æ–‡ä»¶ä¼ è¾“å¯¹è±¡
QStandardItemModel *m_model;       // ç¾¤ç»„æˆå‘˜åˆ—è¡¨ï¼ˆç¾¤èŠæ—¶ä½¿ç”¨ï¼‰
```

**å…³é”®æ–¹æ³•**ï¼š
```cpp
// è®¾ç½®èŠå¤©å¯¹è±¡
void SetCell(QQCell *cell, const quint8 &type = 0);

// æ·»åŠ æ¶ˆæ¯ï¼ˆæ¥æ”¶åˆ°çš„ï¼‰
void AddMessage(const QJsonValue &json);

// å‘é€æ¶ˆæ¯
void on_btnSendMsg_clicked();
```

**ä¿¡å·**ï¼š
```cpp
signals:
    void signalClose();  // çª—å£å…³é—­ä¿¡å·
    void signalSendMessage(const quint8 &type, const QJsonValue &json);
```

**ä¸å…¶ä»–ç±»çš„å…³ç³»**ï¼š
- **è¢« MainWindow åˆ›å»ºå’Œç®¡ç†**
- **ä½¿ç”¨ ClientFileSocket**ï¼šæ–‡ä»¶ä¼ è¾“
- **ä½¿ç”¨ DataBaseMagr**ï¼šä¿å­˜/åŠ è½½å†å²è®°å½•
- **å‘å°„ä¿¡å·ç»™ MainWindow**ï¼šé€šçŸ¥å‘é€æ¶ˆæ¯

---

### ä¸‰ã€æœåŠ¡å™¨ç«¯ç±»å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      main.cpp                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   MyApp      â”‚  â”‚ DataBaseMagr â”‚  â”‚  MainWindow   â”‚  â”‚
â”‚  â”‚ (é…ç½®ç®¡ç†)    â”‚  â”‚ (æ•°æ®åº“ç®¡ç†)  â”‚  â”‚  (ç®¡ç†ç•Œé¢)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚          â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                    â”‚  TcpMsgServer    â”‚  â”‚
â”‚                                    â”‚  (æ¶ˆæ¯æœåŠ¡å™¨)      â”‚  â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚          â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                      â”‚                        â”‚        â”‚ â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚            â”‚ ClientSocket   â”‚      â”‚ ClientSocket   â”‚ â”‚ â”‚
â”‚            â”‚  (å®¢æˆ·ç«¯1)      â”‚      â”‚  (å®¢æˆ·ç«¯2)      â”‚ â”‚ â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                      â”‚                        â”‚        â”‚ â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚                                   â”‚                    â”‚ â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚                          â”‚  DataBaseMagr   â”‚          â”‚ â”‚
â”‚                          â”‚  (æ•°æ®åº“æŸ¥è¯¢)    â”‚          â”‚ â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å››ã€æœåŠ¡å™¨ç«¯æ ¸å¿ƒç±»

#### 4.1 TcpMsgServerï¼ˆæ¶ˆæ¯æœåŠ¡å™¨ï¼‰

**ä½ç½®**ï¼š`tcpserver.*`

**èŒè´£**ï¼š
- ç›‘å¬å®¢æˆ·ç«¯è¿æ¥
- ç®¡ç†å®¢æˆ·ç«¯è¿æ¥åˆ—è¡¨
- è½¬å‘æ¶ˆæ¯

**å…³é”®æˆå‘˜å˜é‡**ï¼š
```cpp
QVector<ClientSocket *> m_clients;  // å®¢æˆ·ç«¯è¿æ¥åˆ—è¡¨
```

**å…³é”®æ–¹æ³•**ï¼š
```cpp
// å¯åŠ¨æœåŠ¡å™¨
bool StartListen(int port = 6666);

// æ–°è¿æ¥å¤„ç†
void SltNewConnection();

// æ¶ˆæ¯è½¬å‘
void SltMsgToClient(const quint8 &type, const int &id, const QJsonValue &json);
```

**å·¥ä½œæµç¨‹**ï¼š
1. ç›‘å¬ç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
2. æ–°è¿æ¥åˆ°è¾¾æ—¶ï¼Œåˆ›å»º `ClientSocket` å¯¹è±¡
3. å®¢æˆ·ç«¯ç™»å½•æˆåŠŸåï¼ŒåŠ å…¥ `m_clients` åˆ—è¡¨
4. æ”¶åˆ°æ¶ˆæ¯è½¬å‘è¯·æ±‚æ—¶ï¼ŒæŸ¥æ‰¾ç›®æ ‡å®¢æˆ·ç«¯å¹¶è½¬å‘

#### 4.2 ClientSocketï¼ˆæœåŠ¡å™¨ç«¯å®¢æˆ·ç«¯è¿æ¥ï¼‰

**ä½ç½®**ï¼š`clientsocket.*`ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

**èŒè´£**ï¼š
- ç®¡ç†å•ä¸ªå®¢æˆ·ç«¯è¿æ¥
- è§£æå®¢æˆ·ç«¯æ¶ˆæ¯
- å¤„ç†ä¸šåŠ¡é€»è¾‘
- å‘é€å“åº”æ¶ˆæ¯

**å…³é”®æ–¹æ³•**ï¼š
```cpp
// æ¶ˆæ¯æ¥æ”¶
void SltReadyRead();

// æ¶ˆæ¯å¤„ç†
void ParseLogin(const QJsonValue &dataVal);
void ParseSendMessage(const int &fromId, const QJsonValue &dataVal);
void ParseSendGroupMessage(const int &fromId, const QJsonValue &dataVal);
```

**ä¿¡å·**ï¼š
```cpp
signals:
    void signalConnected();      // è¿æ¥æˆåŠŸ
    void signalDisConnected();   // æ–­å¼€è¿æ¥
    void signalMsgToClient(...); // éœ€è¦è½¬å‘çš„æ¶ˆæ¯
```

**ä¸å…¶ä»–ç±»çš„å…³ç³»**ï¼š
- **è¢« TcpMsgServer ç®¡ç†**ï¼šåŠ å…¥å®¢æˆ·ç«¯åˆ—è¡¨
- **ä½¿ç”¨ DataBaseMagr**ï¼šéªŒè¯ç”¨æˆ·ã€æŸ¥è¯¢æ•°æ®
- **å‘å°„ä¿¡å·ç»™ TcpMsgServer**ï¼šè¯·æ±‚è½¬å‘æ¶ˆæ¯

---

## ğŸ“Š æ•°æ®æµè½¬è¿‡ç¨‹

### ä¸€ã€ç™»å½•æµç¨‹

```
[ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ]
        â†“
[LoginWidget::on_btnLogin_clicked()]
        â†“
æ„é€ ç™»å½• JSON: {name: "admin", passwd: "123456"}
        â†“
[ClientSocket::SltSendMessage(Login, json)]
        â†“
[ç½‘ç»œä¼ è¾“]
        â†“
[æœåŠ¡å™¨ ClientSocket::SltReadyRead()]
        â†“
[æœåŠ¡å™¨ ClientSocket::ParseLogin()]
        â†“
[æœåŠ¡å™¨ DataBaseMagr::CheckUserLogin()]
        â†“
æŸ¥è¯¢æ•°æ®åº“: SELECT * FROM USERINFO WHERE name='admin' AND passwd='123456'
        â†“
[æœåŠ¡å™¨ ClientSocket] æ„é€ å“åº” JSON
        â†“
[ç½‘ç»œä¼ è¾“]
        â†“
[å®¢æˆ·ç«¯ ClientSocket::SltReadyRead()]
        â†“
[å®¢æˆ·ç«¯ ClientSocket::ParseLogin()]
        â†“
[å®¢æˆ·ç«¯ LoginWidget] æ¥æ”¶ä¿¡å·
        â†“
ç™»å½•æˆåŠŸ â†’ åˆ›å»º MainWindow
        â†“
[MainWindow::SetSocket()] è®¾ç½® Socket
        â†“
[MainWindow] ä»æ•°æ®åº“åŠ è½½å¥½å‹åˆ—è¡¨
        â†“
[DataBaseMagr::GetMyFriend()] æŸ¥è¯¢æœ¬åœ°æ•°æ®åº“
        â†“
æ˜¾ç¤ºä¸»ç•Œé¢
```

### äºŒã€å‘é€æ¶ˆæ¯æµç¨‹

```
[ç”¨æˆ·åœ¨ ChatWindow è¾“å…¥æ¶ˆæ¯]
        â†“
[ChatWindow::on_btnSendMsg_clicked()]
        â†“
æ„é€ æ¶ˆæ¯ JSON: {id: 1002, text: "ä½ å¥½", time: "2024/01/01 12:00"}
        â†“
å‘å°„ä¿¡å·: signalSendMessage(SendMsg, json)
        â†“
[MainWindow::SltTcpReply()] æ¥æ”¶ä¿¡å·
        â†“
[MainWindow] è°ƒç”¨ ClientSocket::SltSendMessage()
        â†“
[ClientSocket] JSON åºåˆ—åŒ–å¹¶å‘é€
        â†“
[ç½‘ç»œä¼ è¾“]
        â†“
[æœåŠ¡å™¨ ClientSocket::SltReadyRead()]
        â†“
[æœåŠ¡å™¨ ClientSocket::ParseSendMessage()]
        â†“
è§£ææ¶ˆæ¯ï¼Œè·å–ç›®æ ‡ç”¨æˆ·ID (toId = 1002)
        â†“
å‘å°„ä¿¡å·: signalMsgToClient(SendMsg, 1002, json)
        â†“
[TcpMsgServer::SltMsgToClient()] æ¥æ”¶ä¿¡å·
        â†“
éå† m_clientsï¼Œæ‰¾åˆ° userId == 1002 çš„å®¢æˆ·ç«¯
        â†“
[ç›®æ ‡ ClientSocket::SendMessage()] å‘é€æ¶ˆæ¯
        â†“
[ç½‘ç»œä¼ è¾“]
        â†“
[ç›®æ ‡å®¢æˆ·ç«¯ ClientSocket::SltReadyRead()]
        â†“
[ç›®æ ‡å®¢æˆ·ç«¯ MainWindow::SltTcpReply()]
        â†“
[ç›®æ ‡å®¢æˆ·ç«¯ MainWindow::ParseFriendMessageReply()]
        â†“
æŸ¥æ‰¾æˆ–åˆ›å»º ChatWindow
        â†“
[ChatWindow::AddMessage()] æ˜¾ç¤ºæ¶ˆæ¯
        â†“
[DataBaseMagr::AddHistoryMsg()] ä¿å­˜åˆ°æ•°æ®åº“
        â†“
æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
```

### ä¸‰ã€åŠ è½½å†å²è®°å½•æµç¨‹

```
[ç”¨æˆ·æ‰“å¼€èŠå¤©çª—å£]
        â†“
[ChatWindow::SetCell()]
        â†“
[ChatWindow] è°ƒç”¨ DataBaseMagr::QueryHistory()
        â†“
[DataBaseMagr] æ‰§è¡Œ SQL:
  SELECT * FROM MSGINFO 
  WHERE userId=1002 
  ORDER BY id ASC 
  LIMIT 20
        â†“
[DataBaseMagr] è¿”å› QVector<ItemInfo*>
        â†“
[ChatWindow] éå† ItemInfoï¼Œæ ¼å¼åŒ–ä¸º HTML
        â†“
[ChatWindow] æ·»åŠ åˆ° QTextBrowser æ˜¾ç¤º
        â†“
ç”¨æˆ·çœ‹åˆ°å†å²æ¶ˆæ¯
```

### å››ã€æ·»åŠ å¥½å‹æµç¨‹

```
[ç”¨æˆ·åœ¨ MainWindow å³é”®èœå•é€‰æ‹©"æ·»åŠ å¥½å‹"]
        â†“
[MainWindow::onAddFriendMenuDidSelected()]
        â†“
å¼¹å‡ºè¾“å…¥æ¡†ï¼Œç”¨æˆ·è¾“å…¥å¥½å‹ç”¨æˆ·å
        â†“
[MainWindow] è°ƒç”¨ ClientSocket::SltSendMessage(AddFriend, json)
        â†“
[ç½‘ç»œä¼ è¾“]
        â†“
[æœåŠ¡å™¨ ClientSocket::ParseAddFriend()]
        â†“
[æœåŠ¡å™¨ DataBaseMagr::AddFriend()] æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        â†“
[æœåŠ¡å™¨] è¿”å›ç”¨æˆ·ä¿¡æ¯ JSON
        â†“
[å®¢æˆ·ç«¯ MainWindow::ParseAddFriendReply()]
        â†“
[å®¢æˆ·ç«¯ DataBaseMagr::AddFriend()] ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
        â†“
[å®¢æˆ·ç«¯ MainWindow] åˆ·æ–°å¥½å‹åˆ—è¡¨
        â†“
æ–°å¥½å‹æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
```

---

## ğŸ¨ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰

**åº”ç”¨ä½ç½®**ï¼š`DataBaseMagr`

**å®ç°**ï¼š
```cpp
class DataBaseMagr {
private:
    static DataBaseMagr *self;
    
public:
    static DataBaseMagr *Instance() {
        static QMutex mutex;
        if (NULL == self) {
            QMutexLocker locker(&mutex);
            if (!self) {
                self = new DataBaseMagr();
            }
        }
        return self;
    }
};
```

**ä¼˜åŠ¿**ï¼š
- âœ… å…¨å±€å”¯ä¸€å®ä¾‹
- âœ… çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨äº’æ–¥é”ï¼‰
- âœ… å»¶è¿Ÿåˆå§‹åŒ–

### 2. è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserverï¼‰

**åº”ç”¨ä½ç½®**ï¼šQt ä¿¡å·æ§½æœºåˆ¶

**ç¤ºä¾‹**ï¼š
```cpp
// ClientSocket å‘å°„ä¿¡å·
connect(m_tcpSocket, SIGNAL(readyRead()), 
        this, SLOT(SltReadyRead()));

// MainWindow ç›‘å¬ä¿¡å·
connect(m_tcpSocket, SIGNAL(signalMessage(quint8,QJsonValue)), 
        this, SLOT(SltTcpReply(quint8,QJsonValue)));
```

**ä¼˜åŠ¿**ï¼š
- âœ… è§£è€¦å‘é€è€…å’Œæ¥æ”¶è€…
- âœ… æ”¯æŒä¸€å¯¹å¤šé€šçŸ¥
- âœ… Qt æ¡†æ¶åŸç”Ÿæ”¯æŒ

### 3. å·¥å‚æ¨¡å¼ï¼ˆFactoryï¼‰

**åº”ç”¨ä½ç½®**ï¼š`TcpMsgServer` åˆ›å»º `ClientSocket`

```cpp
void TcpMsgServer::SltNewConnection()
{
    QTcpSocket *socket = m_tcpServer->nextPendingConnection();
    ClientSocket *client = new ClientSocket(this, socket);
    // ...
}
```

### 4. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Methodï¼‰

**åº”ç”¨ä½ç½®**ï¼š`TcpServer` åŸºç±»

```cpp
class TcpServer {
protected slots:
    virtual void SltNewConnection() = 0;  // å­ç±»å®ç°
    virtual void SltConnected() = 0;
    virtual void SltDisConnected() = 0;
};

class TcpMsgServer : public TcpServer {
    void SltNewConnection() override { /* å…·ä½“å®ç° */ }
};
```

---

## ğŸ’» å…³é”®ä»£ç åˆ†æ

### 1. æ•°æ®åº“å•ä¾‹ä½¿ç”¨

```cpp
// åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨æ•°æ®åº“
DataBaseMagr *db = DataBaseMagr::Instance();
db->AddFriend(1002, 1001, "å¼ ä¸‰");
```

**æ³¨æ„**ï¼š
- ä¸éœ€è¦ `new`ï¼Œç›´æ¥è°ƒç”¨ `Instance()`
- å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹
- çº¿ç¨‹å®‰å…¨

### 2. æ¶ˆæ¯å‘é€å°è£…

```cpp
// ChatWindow å‘é€æ¶ˆæ¯
void ChatWindow::on_btnSendMsg_clicked()
{
    QJsonObject json;
    json.insert("id", m_cell->id);
    json.insert("text", ui->textEditMsg->toPlainText());
    
    // å‘å°„ä¿¡å·ï¼Œç”± MainWindow å¤„ç†
    Q_EMIT signalSendMessage(SendMsg, json);
}

// MainWindow æ¥æ”¶ä¿¡å·å¹¶å‘é€
void MainWindow::SltTcpReply(const quint8 &type, const QJsonValue &dataVal)
{
    if (type == SendMsg) {
        m_tcpSocket->SltSendMessage(SendMsg, dataVal);
    }
}
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- ChatWindow ä¸éœ€è¦ç›´æ¥æ“ä½œ Socket
- é€šè¿‡ä¿¡å·æ§½è§£è€¦
- MainWindow ç»Ÿä¸€ç®¡ç†æ¶ˆæ¯å‘é€

### 3. æ¶ˆæ¯è·¯ç”±åˆ†å‘

```cpp
// æœåŠ¡å™¨ç«¯æ¶ˆæ¯è½¬å‘
void TcpMsgServer::SltMsgToClient(const quint8 &type, 
                                   const int &id, 
                                   const QJsonValue &json)
{
    // éå†æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œæ‰¾åˆ°ç›®æ ‡
    foreach (ClientSocket *client, m_clients) {
        if (client->GetUserId() == id) {
            client->SendMessage(type, json);
            break;
        }
    }
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- å¯ä»¥ä½¿ç”¨ `QHash<int, ClientSocket*>` æé«˜æŸ¥æ‰¾æ•ˆç‡
- æ”¯æŒç¦»çº¿æ¶ˆæ¯å­˜å‚¨

---

## ğŸ“ æ€»ç»“

### æ•°æ®åº“è®¾è®¡è¦ç‚¹

1. **å®¢æˆ·ç«¯**ï¼šåˆ†ç¦»ç”¨æˆ·æ•°æ®å’Œæ¶ˆæ¯æ•°æ®ï¼Œæœ¬åœ°ç¼“å­˜æå‡ä½“éªŒ
2. **æœåŠ¡å™¨ç«¯**ï¼šé›†ä¸­ç®¡ç†ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
3. **è¡¨è®¾è®¡**ï¼šç®€å•å®ç”¨ï¼Œä½†å¯ä»¥è¿›ä¸€æ­¥è§„èŒƒåŒ–

### ç±»é…åˆè¦ç‚¹

1. **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ªç±»åªè´Ÿè´£è‡ªå·±çš„åŠŸèƒ½
2. **ä¿¡å·æ§½é€šä¿¡**ï¼šè§£è€¦ç±»ä¹‹é—´çš„ä¾èµ–
3. **å•ä¾‹æ¨¡å¼**ï¼šæ•°æ®åº“ç®¡ç†å…¨å±€å”¯ä¸€
4. **çª—å£ç®¡ç†**ï¼šMainWindow ç»Ÿä¸€ç®¡ç†å­çª—å£

### æ”¹è¿›å»ºè®®

1. **æ•°æ®åº“**ï¼š
   - æ·»åŠ ç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
   - å¯†ç åŠ å¯†å­˜å‚¨
   - è§„èŒƒåŒ–ç¾¤ç»„è¡¨è®¾è®¡

2. **ç±»è®¾è®¡**ï¼š
   - ä½¿ç”¨æ¥å£æŠ½è±¡ï¼Œæé«˜å¯æ‰©å±•æ€§
   - æ·»åŠ é”™è¯¯å¤„ç†æœºåˆ¶
   - å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ”¯æŒç¦»çº¿æ¶ˆæ¯

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å®¢æˆ·ç«¯åˆ—è¡¨ä½¿ç”¨ Hash è¡¨
   - æ¶ˆæ¯åˆ†é¡µåŠ è½½
   - æ•°æ®åº“è¿æ¥æ± 

---

**å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£é¡¹ç›®çš„æ•°æ®åº“è®¾è®¡å’Œç±»ä¹‹é—´çš„é…åˆå…³ç³»ï¼**

